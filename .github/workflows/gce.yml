name: Build, Push and Deploy to Digital Ocean

on:
    push:
        branches:
            - master

env:
    PROJECT_ID: ${{ secrets.GCE_PROJECT }}
    GCE_INSTANCE: ${{ secrets.GCE_INSTANCE_NAME }}
    GCE_INSTANCE_ZONE: ${{ secrets.GCE_INSTANCE_ZONE }}

jobs:
    setup-build-deploy:
        name: Setup, build, and deploy
        runs-on: ubuntu-latest

        steps:

        # checkout branch
        - name: Checkout
          uses: actions/checkout@v2 

        # login to docker
        - name: Login to docker
          run: echo ${{ secrets.DOCKER_PASSWORD }} | docker login --username ${{ secrets.DOCKER_USERNAME }} --password-stdin

        # build image
        - name: Build docker image
          run: docker build -t jeffstjean/enactushacks_nodejs ./api

        # push image
        - name: Push docker image
          run: docker push jeffstjean/enactushacks_nodejs

        # install ssh keys
        - name: Instal SSH key
          uses: webfactory/ssh-agent@v0.4.0
          with:
            ssh-private-key: ${{ secrets.DEPLOY_KEY }}

        # ssh to server
        - name: SSH to server
          run: ssh ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}

        # deploy
        - name: Deploy to DigitalOcean
          run: stack deploy -c test/docker-compose.yml eh_prod

        # deploy
        # - name: Deploy to digitalocean
        #   uses: fifsky/ssh-action@master
        #   with:
        #     host: ${{ secrets.DEPLOY_HOST }}
        #     user: ${{ secrets.DEPLOY_USER }}
        #     ssh_private_key: ${{ secrets.DEPLOY_KEY }}
        #     command: stack deploy -c test/docker-compose.yml eh_prod

